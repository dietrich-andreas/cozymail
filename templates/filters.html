<!-- filters.html -->
{% extends "base.html" %}
{% set title = "Filter" %}
{% block content %}
<h1 class="title">ğŸ§ª E-Mail-Filter</h1>
<p class="subtitle">Filterregeln fÃ¼r eingehende Mails definieren</p>

<!-- Tabs fÃ¼r Accounts -->
<div class="tabs is-boxed">
  <ul>
    {% for acc in accounts %}
      <li class="{% if acc.id == active_account %}is-active{% endif %}">
        <a href="?account={{ acc.id }}">{{ acc.username }}</a>
      </li>
    {% endfor %}
  </ul>
</div>

<!-- Filterformular -->
<form method="post">
  <div class="columns is-vcentered">
    <div class="column is-2">
      <div class="select is-fullwidth">
        <select name="field">
          <option value="from">Von</option>
          <option value="to">An</option>
          <option value="subject">Betreff</option>
        </select>
      </div>
    </div>
    <div class="column is-2">
      <div class="select is-fullwidth">
        <select name="mode">
          <option value="exact">ist genau</option>
          <option value="contains">enthÃ¤lt</option>
          <option value="startswith">beginnt mit</option>
          <option value="endswith">endet mit</option>
          <option value="regex">RegEx</option>
        </select>
      </div>
    </div>
    <div class="column">
      <input class="input" type="text" name="value" placeholder="Wert eingeben" required>
    </div>
    <div class="column is-narrow">
      <button class="button is-primary" type="submit">â• HinzufÃ¼gen</button>
    </div>
  </div>

  <div class="columns is-vcentered">
    <div class="column is-3">
      <label class="label">Zielordner</label>
      <input class="input" type="text" name="target_folder" value="INBOX.">
    </div>
    <div class="column is-2">
      <label class="checkbox mt-5">
        <input type="checkbox" name="is_read"> Als gelesen markieren
      </label>
    </div>
    <div class="column is-2">
      <label class="checkbox mt-5">
        <input type="checkbox" name="active" checked> Aktiv
      </label>
    </div>
  </div>
</form>

<hr>

<!-- Filterliste -->
<h2 class="subtitle">Aktive Filter fÃ¼r dieses Konto</h2>

{% if filters %}
<table class="table is-fullwidth is-striped">
  <thead>
    <tr>
      <th>Feld</th>
      <th>Modus</th>
      <th>Wert</th>
      <th>Zielordner</th>
      <th>Treffer</th>
      <th>Zuletzt</th>
      <th>Gelesen</th>
      <th>Status</th>
      <th class="has-text-centered" style="width:90px">Aktion</th>
    </tr>
  </thead>
  <tbody>
    {% for f in filters %}
    <tr>
      <td>{% if f.field == "from" %}Von{% elif f.field == "to" %}An{% else %}Betreff{% endif %}</td>
      <td>
        {% if f.mode == "exact" %}ist genau
        {% elif f.mode == "contains" %}enthÃ¤lt
        {% elif f.mode == "startswith" %}beginnt mit
        {% elif f.mode == "endswith" %}endet mit
        {% elif f.mode == "regex" %}RegEx
        {% else %}{{ f.mode }}
        {% endif %}
      </td>
      <td>{{ f.value }}</td>
      <td>{{ (f.target_folder or "INBOX.") | urldecode }}</td>
      <td>{{ f.usage_count or 0 }}</td>
      <td>
        {% if f.last_used %}
          {% set dt = f.last_used.replace('T',' ') %}
          {% set y = dt[:4] %}
          {% set m = dt[5:7] %}
          {% set d = dt[8:10] %}
          {% set hm = dt[11:16] %}
          {{ d }}.{{ m }}.{{ y }} {{ hm }} Uhr
        {% else %}
          â€“
        {% endif %}
      </td>
      <td>{{ "âœ…" if f.is_read else "âŒ" }}</td>
      <td class="has-text-centered">
        {% if f.active %}
          <span title="Aktiv">ğŸŸ¢</span>
        {% else %}
          <span title="Inaktiv">ğŸ”´</span>
        {% endif %}
      </td>
      <td class="is-narrow has-text-centered">
        <a class="button is-small is-info is-light"  href="{{ url_for('edit_filter', filter_id=f.id, account_id=active_account) }}" title="Bearbeiten" aria-label="Bearbeiten">âœï¸</a>
        <form method="post" action="/filters/delete" style="display:inline">
          <input type="hidden" name="filter_id" value="{{ f.id }}">
          <input type="hidden" name="account_id" value="{{ active_account }}">
          <button class="button is-small is-danger is-light" type="submit" title="LÃ¶schen" aria-label="LÃ¶schen">ğŸ—‘ï¸</button>
        </form>
        <form method="post" action="{{ url_for('toggle_filter', filter_id=f.id) }}" style="display:inline">
          <input type="hidden" name="account_id" value="{{ active_account }}">
          <button class="button is-small is-light {{ 'is-success' if f.active else '' }}"
                  title="{{ 'Deaktivieren' if f.active else 'Aktivieren' }}"
                  aria-label="Toggle aktiv">
            {{ 'ğŸŸ¢' if f.active else 'ğŸ”´' }}
          </button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p><em>Keine Filter fÃ¼r dieses Konto vorhanden.</em></p>
{% endif %}
{% endblock %}
