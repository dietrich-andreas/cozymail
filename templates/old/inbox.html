<!-- inbox.html -->
{% extends "base.html" %}
{% set title = "Posteingang" %}
{% block head %}
<style>
  .domain { color: gray; font-size: 0.85em; }
  .from-info { word-break: break-word; }
  .table td { vertical-align: top; }
  .subject-header { display: flex; justify-content: space-between; align-items: start; }
  .modal-card { width: 90vw; max-width: none; }
  .modal-card-body pre { overflow-x: auto; white-space: pre-wrap; }
  .account-header { display: flex; justify-content: space-between; align-items: center; }
  .modal-card-body pre { white-space: pre-wrap; word-break: break-word; }
</style>
{% endblock %}
{% block content %}
<div class="account-header">
  <h1 class="title">üì• Ungelesene Mails im Posteingang</h1>
  <a class="button is-small is-info" href="/?account={{ active_account }}">üîÑ</a>
</div>

<div class="tabs is-boxed">
  <ul id="account-tabs">
    {% for acc in accounts %}
      <li class="{% if acc.id == active_account %}is-active{% endif %}" data-id="{{ acc.id }}" title="X-Spam-Level: {{ acc.x_spam_level }}">
        <a href="/?account={{ acc.id }}">{{ acc.unread_display }}</a>
      </li>
    {% endfor %}
  </ul>
</div>

<table class="table is-striped is-hoverable is-fullwidth" id="mail-table">
  <thead>
    <tr>
      <th>Aktion</th>
      <th>Betreff</th>
      <th>Von</th>
      <th>Datum</th>
    </tr>
  </thead>
  <tbody id="mail-body">
    <tr><td colspan="4">üîÑ Mails werden geladen...</td></tr>
  </tbody>
</table>

<div id="modals"></div>
{% endblock %}

{% block scripts %}
<script>
  const DEBUG = {{ debug_mode|default(false)|tojson }};
</script>
<script>
"use strict";

/**
 * Globale Fetch-Helfer mit 401-Handling f√ºr abgelaufene Sessions.
 * - Setzt X-Requested-With, damit der Server zwischen AJAX & HTML unterscheiden kann
 * - Leitet bei 401 per window.location auf die Login-Seite (aus JSON.redirect oder /login)
 */
async function apiFetch(url, options = {}) {
  const finalOptions = {
    credentials: "include",
    headers: { "X-Requested-With": "XMLHttpRequest", ...(options.headers || {}) },
    ...options,
  };

  const res = await fetch(url, finalOptions);
  if (res.status === 401) {
    let target = "/login";
    try {
      const data = await res.json();
      if (data && data.redirect) target = data.redirect;
    } catch (_) { /* response war kein JSON ‚Üí fallback */ }
    if (DEBUG) console.warn("Session abgelaufen ‚Üí Redirect:", target);
    window.location.href = target;
    throw new Error("Session expired");
  }
  return res;
}

/**
 * Parst JSON-Antworten und wirft bei HTTP-Fehlern mit detail.
 */
async function apiJson(url, options = {}) {
  const res = await apiFetch(url, options);
  const ct = res.headers.get("content-type") || "";
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  if (!ct.includes("application/json")) throw new Error("Unerwartetes Response-Format (kein JSON)");
  return res.json();
}

const activeAccount = {{ active_account|tojson }};
let safeHtml = {};

async function fetchMails() {
  if (!activeAccount || typeof activeAccount !== "number") {
    console.warn("‚ö†Ô∏è Kein g√ºltiges Konto ausgew√§hlt. activeAccount:", activeAccount);
    return;
  }

  try {
    const data = await apiJson(`/api/mails?account_id=${activeAccount}`);
    const tbody = document.getElementById("mail-body");
    tbody.innerHTML = "";
    const modalContainer = document.getElementById("modals");
    if (!document.querySelector(".modal.is-active")) {
      modalContainer.innerHTML = "";
    }

    if (!Array.isArray(data) || !data.length) {
      tbody.innerHTML = '<tr><td colspan="4">Keine neuen Mails</td></tr>';
      return;
    }

    data.forEach(mail => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>
          <div class="icon-actions">
            <button class="button is-light is-small" onclick="markSpam(${mail.id})" title="Als Spam markieren">üî•</button>
            <button class="button is-light is-small" onclick="markHam(${mail.id})" title="Absender whitelisten">‚úÖ</button>
            <button class="button is-light is-small" onclick="deleteMail(${mail.id})" title="L√∂schen">üóëÔ∏è</button>
            <button class="button is-light is-small" onclick="markRead(${mail.id})" title="Als gelesen markieren">üîµ</button>
          </div>
        </td>
        <td>
          <div class="subject-header">
            <span>${mail.subject}</span>
            <button class="button is-small is-info is-light ml-2" onclick="loadModal(${mail.id})">üîç</button>
          </div>
        </td>
        <td class="from-info">
          <span class="nowrap-from">${mail.from_ || mail.sender}</span><br>
          <span class="domain">
            ${mail.domain || ""}
            ${mail.whitelisted ? '<span class="tag is-success is-light is-rounded" title="Absender ist auf der Whitelist">‚úÖ Whitelist</span>' : ""}
          </span>
        </td>
        <td>${mail.date?.split("T")[0] || ""}</td>
      `;
      tbody.appendChild(row);
    });
  } catch (err) {
    if (DEBUG) console.error("fetchMails() Fehler:", err);
    const tbody = document.getElementById("mail-body");
    tbody.innerHTML = '<tr><td colspan="4">‚ö†Ô∏è Fehler beim Laden der Mails</td></tr>';
  }
}

async function fetchUnreadCounts() {
  try {
    const counts = await apiJson("/api/unread_counts");
    counts.forEach(entry => {
      const tab = document.querySelector(`#account-tabs li[data-id='${entry.account_id}'] a`);
      if (tab) tab.textContent = `${tab.textContent.split(" (")[0]} (${entry.unread})`;
    });
  } catch (err) {
    if (DEBUG) console.warn("fetchUnreadCounts()", err);
  }
}

async function markRead(id) {
  try {
    const data = await apiJson("/api/mail/read", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id })
    });
    if (data.status === "ok") {
      hideModal(id);
      fetchMails();
      fetchUnreadCounts();
    } else {
      console.error("Fehler:", data.message);
      alert("Markieren fehlgeschlagen: " + (data.message || "Unbekannter Fehler"));
    }
  } catch (err) {
    console.error("Fehler:", err);
    alert("Netzwerkfehler beim Markieren als gelesen");
  }
}

async function deleteMail(id) {
  try {
    await apiFetch("/api/mail/delete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id })
    });
    hideModal(id);
    fetchMails();
    fetchUnreadCounts();
  } catch (err) {
    if (DEBUG) console.error("deleteMail()", err);
  }
}

async function markSpam(id) {
  try {
    await apiFetch("/api/mail/spam", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id })
    });
    hideModal(id);
    fetchMails();
    fetchUnreadCounts();
  } catch (err) {
    if (DEBUG) console.error("markSpam()", err);
  }
}

async function markHam(id) {
  try {
    await apiFetch("/api/mail/ham", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id })
    });
    fetchMails();
  } catch (err) {
    if (DEBUG) console.error("markHam()", err);
  }
}

async function loadModal(id) {
  try {
    const mail = await apiJson(`/api/mail?id=${id}`);
    const modalHTML = `
    <div id="modal-${mail.id}" class="modal is-active">
      <div class="modal-background" onclick="hideModal(${mail.id})"></div>
      <div class="modal-card">
        <header class="modal-card-head modal-header-layout">
          <div class="modal-header-left">
            <p class="modal-card-title">Mail anzeigen</p>
          </div>
          <div class="modal-header-center">
            <div id="view-toggle-${mail.id}" class="buttons mb-3">
              <button class="button is-outlined is-link" onclick="toggleView('${mail.id}', 'headers')">Kopfzeilen</button>
              <button class="button is-outlined is-primary" onclick="toggleView('${mail.id}', 'plain')">Text</button>
              <button class="button is-outlined is-primary" onclick="toggleView('${mail.id}', 'html')">E-Mail-Inhalt</button>
              <button class="button is-outlined is-primary" onclick="loadUnsafeHtml(${mail.id}); toggleView('${mail.id}', 'unsafe')">Externe Inhalte anzeigen</button>
            </div>
          </div>
          <div class="modal-header-right">
            <button class="delete" aria-label="close" onclick="hideModal(${mail.id})"></button>
          </div>
        </header>
        <section class="modal-card-body">
          <pre id="modal-headers-${mail.id}" style="display:none;">${(mail.headers || "").replace(/\\r?\\n/g, "<br>")}</pre>
          <pre id="modal-body-${mail.id}" style="display:none;">${mail.body || "(kein Inhalt)"}</pre>
          <iframe id="modal-html-${mail.id}" style="display:none; width:100%; height:60vh; border:1px solid #ccc;" sandbox="allow-same-origin"></iframe>
        </section>
        <footer class="modal-card-foot is-justify-content-space-between is-flex-wrap-wrap">
          <div class="has-text-left is-size-7">
            <p><strong>Von:</strong> ${mail.sender || "(unbekannt)"}</p>
            <p><strong>An:</strong> ${mail.recipient || "(unbekannt)"}</p>
            <p><strong>Betreff:</strong> ${mail.subject || "(kein Betreff)"}</p>
          </div>
          <div class="has-text-right is-flex is-flex-direction-column is-align-items-end">
            <div class="buttons are-small">
              <button class="button is-danger is-light" onclick="markSpam(${mail.id}, true)">üî• Spam</button>
              <button class="button is-warning is-light" onclick="deleteMail(${mail.id}, true)">üóëÔ∏è L√∂schen</button>
              <button class="button is-info is-light" onclick="markRead(${mail.id}, true)">üîµ Gelesen</button>
            </div>
            <p class="is-size-7 mt-2">${formatDateGerman(mail.date)}</p>
          </div>
        </footer>
      </div>
    </div>`;

    document.getElementById("modals").innerHTML = modalHTML;
    toggleView(mail.id, 'html');

    const iframe = document.getElementById(`modal-html-${mail.id}`);
    if (iframe && mail.html_body) {
      iframe.srcdoc = mail.html_body;
      iframe.style.display = "block";
    }
    safeHtml[mail.id] = mail.html_body || "<p>(kein HTML-Inhalt)</p>";

    // ESC schlie√üen
    document.addEventListener("keydown", function escListener(evt) {
      if (evt.key === "Escape") {
        hideModal(mail.id);
        document.removeEventListener("keydown", escListener);
      }
    });
  } catch (err) {
    if (DEBUG) console.error("loadModal()", err);
  }
}

function hideModal(id) {
  const modal = document.getElementById(`modal-${id}`);
  if (modal) modal.remove();
}

function toggleView(id, type) {
  const headers = document.getElementById(`modal-headers-${id}`);
  const body = document.getElementById(`modal-body-${id}`);
  const html = document.getElementById(`modal-html-${id}`);

  [headers, body, html].forEach(el => { if (el) el.style.display = "none"; });

  if (type === "headers" && headers) headers.style.display = "block";
  if (type === "plain" && body) body.style.display = "block";

  if (type === "html" && html) {
    html.srcdoc = safeHtml[id] || "<p>(kein Inhalt)</p>";
    html.style.display = "block";
  }

  if (type === "unsafe" && html) {
    html.style.display = "block";
  }

  // Buttons aktiv markieren
  const group = document.getElementById(`view-toggle-${id}`);
  if (group) {
    const buttons = group.querySelectorAll("button");
    const labelMap = {
      headers: "Kopfzeilen",
      plain: "Text",
      html: "E-Mail-Inhalt",
      unsafe: "Externe Inhalte anzeigen"
    };
    buttons.forEach(btn => {
      const isActive = btn.textContent.trim() === labelMap[type];
      btn.className = "button is-outlined " + (isActive ? "is-link" : "is-primary");
    });
  }
}

async function loadUnsafeHtml(id) {
  try {
    const mail = await apiJson(`/api/mail?id=${id}`);
    const iframe = document.getElementById(`modal-html-${id}`);
    if (iframe && mail.html_raw) {
      iframe.srcdoc = mail.html_raw;
    }
  } catch (err) {
    if (DEBUG) console.error("loadUnsafeHtml()", err);
  }
}

let socket; // Globale Variable

document.addEventListener("DOMContentLoaded", function () {
  // Notifications einmalig anfragen (f√ºr Hintergrund-Benachrichtigungen)
  if ("Notification" in window && Notification.permission === "default") {
    Notification.requestPermission().catch(() => {});
  }

  fetchMails();
  fetchUnreadCounts();
  setInterval(fetchUnreadCounts, 15000);

  // Socket.IO Initialisierung (nur einmal, nicht mit const neu deklarieren)
  socket = io("/", {
    transports: ["websocket", "polling"],
    timeout: 5000
  });

  // Event-Handler
  socket.on("connect", () => {
    if (DEBUG) console.log("‚úÖ Verbunden mit WebSocket");
    // Raum f√ºr aktives Konto beitreten
    socket.emit("join_account", { account_id: activeAccount });
  });

  socket.on("mail:deleted", data => {
    if (DEBUG) console.log("üóëÔ∏è Mail gel√∂scht:", data);
    fetchMails();
    fetchUnreadCounts();
  });

  socket.on("mail:read", data => {
    if (DEBUG) console.log("üì≠ Mail als gelesen markiert:", data);
    fetchMails();
    fetchUnreadCounts();
  });

  socket.on("mail_received", data => {
    if (DEBUG) console.log("üì¨ Neue Mail empfangen:", data);
    // Pr√ºfen ob die Mail f√ºr das aktive Konto ist
    if (parseInt(data.account_id) === parseInt(activeAccount)) {
      fetchMails();
      fetchUnreadCounts();
      // Benachrichtigung nur bei nicht aktivem Tab
      if (document.hidden && Notification.permission === "granted") {
        new Notification("Neue Mail", {
          body: data.subject || "Neue Nachricht eingetroffen",
          icon: "/static/icons/mail-notification.png"
        });
      }
    }
  });

  socket.on("disconnect", () => {
    if (DEBUG) console.warn("‚ùå Socket-Verbindung getrennt");
  });
});

// Hilfsfunktion aus bestehendem Code-Kontext beibehalten
function formatDateGerman(isoDate) {
  if (!isoDate) return "";
  try {
    const d = new Date(isoDate);
    return d.toLocaleString("de-DE", { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
  } catch { return isoDate; }
}
</script>
<script src="{{ url_for('static', filename='libs/socket.io.min.js') }}"></script>
{% endblock %}
