<!-- inbox.html -->
{% extends "base.html" %}
{% set title = "Posteingang" %}
{% block head %}
<style>
  :root {
    --col-from: 260px;
    --col-subject: 520px;
  }

  .domain { color: gray; font-size: 0.85em; }
  .from-info { word-break: break-word; }
  .nowrap-from {
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    display: inline-block; max-width: calc(var(--col-from) - 24px);
  }
  .subject-text{
    display: block;
    white-space: normal;        /* war: nowrap */
    word-break: break-word;
    overflow: visible;          /* kein Ellipsis mehr */
    text-overflow: clip;        /* explizit kein â€¦ */
  }
  .table td { vertical-align: middle; }

  /* Spaltenbreiten */
  #mail-table col.col-from    { width: var(--col-from); }
  #mail-table col.col-subject { width: auto; }
  #mail-table col.col-actions { width: 1%; }

  /* 3. Spalte: immer rechtsbÃ¼ndig */
  td.cell-actions { position: relative; text-align: right; white-space: nowrap; }
  .row-date, .row-actions {
    position: absolute; top: 50%; right: 0.75rem; transform: translateY(-50%);
    transition: opacity .15s ease;
  }

  /* beide Spans an exakt derselben Stelle platzieren */
  .row-date { opacity: 1; }
  .row-actions { opacity: 0; pointer-events: none; }
  tr:hover .row-date { opacity: 0; }
  tr:hover .row-actions { opacity: 1; pointer-events: all; }
  .icon-btn.button.is-light.is-small{ padding: .35rem .45rem; }
</style>
{% endblock %}

{% block content %}
<div class="account-header">
  <h1 class="title">ğŸ“¥ Ungelesene Mails im Posteingang</h1>
  <a class="button is-small is-info" href="/?account={{ active_account }}" title="Aktualisieren">ğŸ”„</a>
</div>

<div class="tabs is-boxed">
  <ul id="account-tabs">
    {% for acc in accounts %}
      <li class="{% if acc.id == active_account %}is-active{% endif %}" data-id="{{ acc.id }}" title="X-Spam-Level: {{ acc.x_spam_level }}">
        <a href="/?account={{ acc.id }}">{{ acc.unread_display }}</a>
      </li>
    {% endfor %}
  </ul>
</div>

<table class="table is-striped is-hoverable is-fullwidth" id="mail-table">
  <colgroup>
    <col class="col-from">
    <col class="col-subject">
    <col class="col-actions">
  </colgroup>
  <tbody id="mail-body">
    <tr><td colspan="3">ğŸ”„ Mails werden geladen...</td></tr>
  </tbody>
</table>

<div id="modals"></div>
{% endblock %}

{% block scripts %}
<script>
const DEBUG = {{ debug_mode|default(false)|tojson }};
const activeAccount = {{ active_account|tojson }};
let safeHtml = {};

function formatGermanDateTime(isoString) {
  if (!isoString) return "";
  try {
    const d = new Date(isoString);
    const date = d.toLocaleDateString("de-DE", { day:"2-digit", month:"2-digit", year:"numeric" });
    const time = d.toLocaleTimeString("de-DE", { hour:"2-digit", minute:"2-digit" });
    return `${date} ${time}`;
  } catch { return isoString; }
}

function fetchMails() {
  if (!activeAccount || typeof activeAccount !== "number") {
    console.warn("âš ï¸ Kein gÃ¼ltiges Konto ausgewÃ¤hlt. activeAccount:", activeAccount);
    return;
  }
  fetch(`/api/mails?account_id=${activeAccount}`, { credentials: "include" })
    .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
    .then(data => {
      const tbody = document.getElementById("mail-body");
      tbody.innerHTML = "";
      const modalContainer = document.getElementById("modals");
      if (!document.querySelector(".modal.is-active")) modalContainer.innerHTML = "";

      if (!Array.isArray(data) || !data.length) {
        tbody.innerHTML = '<tr><td colspan="3">Keine neuen Mails</td></tr>';
        return;
      }

      data.forEach(mail => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <!-- Spalte 1: Von -->
          <td class="from-info">
            <span class="nowrap-from">${mail.from_ || mail.sender || "(unbekannt)"}</span><br>
            <span class="domain">
              ${mail.domain || ""}
              ${mail.whitelisted ? '<span class="tag is-success is-light is-rounded" title="Absender ist auf der Whitelist">âœ… Whitelist</span>' : ""}
            </span>
          </td>

          <!-- Spalte 2: Betreff (ohne Button) -->
          <td>
            <span class="subject-text">${mail.subject || "(kein Betreff)"}</span>
          </td>

          <!-- Spalte 3: Datum rechts / Aktionen auf Hover -->
          <td class="cell-actions">
            <span class="row-date">${formatGermanDateTime(mail.date)}</span>
            <span class="row-actions">
              <button class="button is-light is-small icon-btn" onclick="loadModal(${mail.id})" title="Mail anzeigen">ğŸ”</button>
              <button class="button is-light is-small icon-btn" onclick="markSpam(${mail.id}, true)" title="Als Spam markieren">ğŸ”¥</button>
              <button class="button is-light is-small icon-btn" onclick="markHam(${mail.id})" title="Absender whitelisten">âœ…</button>
              <button class="button is-light is-small icon-btn" onclick="deleteMail(${mail.id})" title="LÃ¶schen">ğŸ—‘ï¸</button>
              <button class="button is-light is-small icon-btn" onclick="markRead(${mail.id})" title="Als gelesen markieren">ğŸ”µ</button>
            </span>
          </td>
        `;
        tbody.appendChild(row);
      });
    })
    .catch(err => console.error(err));
}

function fetchUnreadCounts() {
  fetch("/api/unread_counts", { credentials: "include" })
    .then(r => r.json())
    .then(counts => {
      counts.forEach(entry => {
        const tab = document.querySelector(`#account-tabs li[data-id='${entry.account_id}'] a`);
        if (tab) tab.textContent = `${tab.textContent.split(" (")[0]} (${entry.unread})`;
      });
    });
}

function markRead(id) {
  fetch("/api/mail/read", {
    method: "POST", headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id }), credentials: "include"
  }).then(r => r.json()).then(data => {
    if (data.status === "ok") { hideModal(id); fetchMails(); fetchUnreadCounts(); }
    else alert("Markieren fehlgeschlagen: " + (data.message || "Unbekannter Fehler"));
  }).catch(() => alert("Netzwerkfehler beim Markieren als gelesen"));
}

function deleteMail(id) {
  fetch("/api/mail/delete", {
    method: "POST", headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id }), credentials: "include"
  }).then(() => { hideModal(id); fetchMails(); fetchUnreadCounts(); });
}

function markSpam(id, seen = true) {
  fetch("/api/mail/spam", {
    method: "POST", headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id, seen }), credentials: "include"
  })
  .then(r => r.json())
  .then(() => { hideModal(id); fetchMails(); fetchUnreadCounts(); })
  .catch(() => alert("Spam-Markierung fehlgeschlagen."));
}

function markHam(id) {
  fetch("/api/mail/ham", {
    method: "POST", headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id }), credentials: "include"
  }).then(fetchMails);
}

/* ------- Modal (unverÃ¤ndert auÃŸer Hilfsfunktionen) ------- */
function loadModal(id) {
  fetch(`/api/mail?id=${id}`, { credentials: "include" })
    .then(r => r.json())
    .then(mail => {
      const modalHTML = `
      <div id="modal-${mail.id}" class="modal is-active">
        <div class="modal-background" onclick="hideModal(${mail.id})"></div>
        <div class="modal-card">
          <header class="modal-card-head modal-header-layout">
            <p class="modal-card-title">Mail anzeigen</p>
            <button class="delete" aria-label="close" onclick="hideModal(${mail.id})"></button>
          </header>
          <section class="modal-card-body">
            <div class="buttons mb-3" id="view-toggle-${mail.id}">
              <button class="button is-outlined is-link" onclick="toggleView('${mail.id}', 'headers')">Kopfzeilen</button>
              <button class="button is-outlined is-primary" onclick="toggleView('${mail.id}', 'plain')">Text</button>
              <button class="button is-outlined is-primary" onclick="toggleView('${mail.id}', 'html')">E-Mail-Inhalt</button>
              <button class="button is-outlined is-primary" onclick="loadUnsafeHtml(${mail.id}); toggleView('${mail.id}', 'unsafe')">Externe Inhalte anzeigen</button>
            </div>
            <pre id="modal-headers-${mail.id}" style="display:none;">${(mail.headers || "").replace(/\r?\n/g, "<br>")}</pre>
            <pre id="modal-body-${mail.id}" style="display:none;">${mail.body || "(kein Inhalt)"}</pre>
            <iframe id="modal-html-${mail.id}" style="display:none; width:100%; height:60vh; border:1px solid #ccc;" sandbox="allow-same-origin"></iframe>
          </section>
          <footer class="modal-card-foot is-justify-content-space-between is-flex-wrap-wrap">
            <div class="has-text-left is-size-7">
              <p><strong>Von:</strong> ${mail.sender || "(unbekannt)"}</p>
              <p><strong>An:</strong> ${mail.recipient || "(unbekannt)"}</p>
              <p><strong>Betreff:</strong> ${mail.subject || "(kein Betreff)"}</p>
            </div>
            <div class="has-text-right is-flex is-flex-direction-column is-align-items-end">
              <div class="buttons are-small">
                <button class="button is-danger is-light" onclick="markSpam(${mail.id}, true)">ğŸ”¥ Spam</button>
                <button class="button is-success is-light" onclick="markHam(${mail.id})">âœ… Whitelist</button>
                <button class="button is-warning is-light" onclick="deleteMail(${mail.id})">ğŸ—‘ï¸ LÃ¶schen</button>
                <button class="button is-link is-light"    onclick="markRead(${mail.id})">ğŸ”µ Gelesen</button>
              </div>
              <p class="is-size-7 mt-2">${formatGermanDateTime(mail.date)}</p>
            </div>
          </footer>
        </div>
      </div>`;
      document.getElementById("modals").innerHTML = modalHTML;
      toggleView(mail.id, 'html');

      const iframe = document.getElementById(`modal-html-${mail.id}`);
      if (iframe && mail.html_body) { iframe.srcdoc = mail.html_body; iframe.style.display = "block"; }
      safeHtml[mail.id] = mail.html_body || "<p>(kein HTML-Inhalt)</p>";

      document.addEventListener("keydown", function escListener(evt) {
        if (evt.key === "Escape") { hideModal(mail.id); document.removeEventListener("keydown", escListener); }
      });
    });
}

function hideModal(id) { const m = document.getElementById(`modal-${id}`); if (m) m.remove(); }

function toggleView(id, type) {
  const headers = document.getElementById(`modal-headers-${id}`);
  const body = document.getElementById(`modal-body-${id}`);
  const html = document.getElementById(`modal-html-${id}`);
  [headers, body, html].forEach(el => { if (el) el.style.display = "none"; });
  if (type === "headers" && headers) headers.style.display = "block";
  if (type === "plain"   && body)    body.style.display = "block";
  if ((type === "html" || type === "unsafe") && html) { html.style.display = "block"; }

  const group = document.getElementById(`view-toggle-${id}`);
  if (group) {
    const buttons = group.querySelectorAll("button");
    const labelMap = { headers:"Kopfzeilen", plain:"Text", html:"E-Mail-Inhalt", unsafe:"Externe Inhalte anzeigen" };
    buttons.forEach(btn => {
      const isActive = btn.textContent.trim() === labelMap[type];
      btn.className = "button is-outlined " + (isActive ? "is-link" : "is-primary");
    });
  }
}

function loadUnsafeHtml(id) {
  fetch(`/api/mail?id=${id}`, { credentials: "include" })
    .then(r => r.json())
    .then(mail => {
      const iframe = document.getElementById(`modal-html-${id}`);
      if (iframe && mail.html_raw) iframe.srcdoc = mail.html_raw;
    });
}

/* ------- Live-Updates ------- */
let socket;
document.addEventListener("DOMContentLoaded", function () {
  fetchMails();
  fetchUnreadCounts();
  setInterval(fetchUnreadCounts, 15000);

  socket = io("/", { transports: ["websocket","polling"], timeout: 5000 });
  socket.on("connect", () => { if (DEBUG) console.log("âœ… WebSocket verbunden"); socket.emit("join_account", { account_id: activeAccount }); });
  socket.on("mail:deleted", () => { fetchMails(); fetchUnreadCounts(); });
  socket.on("mail:read",    () => { fetchMails(); fetchUnreadCounts(); });
  socket.on("mail_received", data => {
    if (DEBUG) console.log("ğŸ“¬ Neue Mail:", data);
    if (parseInt(data.account_id) === parseInt(activeAccount)) {
      fetchMails(); fetchUnreadCounts();
      if (document.hidden && Notification.permission === "granted") {
        new Notification("Neue Mail", { body: data.subject || "Neue Nachricht", icon: "/static/icons/mail-notification.png" });
      }
    }
  });
  socket.on("disconnect", () => { if (DEBUG) console.warn("âŒ Socket getrennt"); });
});
</script>
<script src="{{ url_for('static', filename='libs/socket.io.min.js') }}"></script>
{% endblock %}
